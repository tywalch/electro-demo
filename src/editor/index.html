<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css">
  </head>
  <div id="container">
    <div id="loader">Loading...</div>
    <div id="editor" style="height: 800px;"></div>
  </div>
  <script>
    document.getElementById("editor").style.height = window.innerHeight + "px";
    // First set up the VSCode loader in a script tag
    const getLoaderScript = document.createElement('script')
    getLoaderScript.src = 'https://www.typescriptlang.org/js/vs.loader.js'
    getLoaderScript.async = true
    getLoaderScript.onload = () => {
      // Now the loader is ready, tell require where it can get the version of monaco, and the sandbox
      // This version uses the latest version of the sandbox, which is used on the TypeScript website

      // For the monaco version you can use unpkg or the TypeSCript web infra CDN
      // You can see the available releases for TypeScript here:
      // https://typescript.azureedge.net/indexes/releases.json
      //
      require.config({
        paths: {
          vs: 'https://typescript.azureedge.net/cdn/4.0.5/monaco/min/vs',
          // vs: 'https://unpkg.com/@typescript-deploys/monaco-editor@4.0.5/min/vs',
          sandbox: 'https://www.typescriptlang.org/js/sandbox',
        },
        // This is something you need for monaco to work
        ignoreDuplicateModules: ['vs/editor/editor.main'],
      })

      // Grab a copy of monaco, TypeScript and the sandbox
      require(['vs/editor/editor.main', 'vs/language/typescript/tsWorker', 'sandbox/index'], (
        main,
        _tsWorker,
        sandboxFactory
      ) => {
        // Write queries on the left, generate parameters to the right
        const initialCode = `/* Play with queries below and see the results! */

import { Entity, Service } from "electrodb";

const table = "your_table_name";

/* Tasks Entity */
const tasks = new Entity(
  {
    model: {
      entity: "tasks",
      version: "1",
      service: "taskapp"
    },
    attributes: {
      organization: {
        type: "string",
        required: true
      },
      task: {
        type: "string",
        required: true
      },
      project: {
        type: "string",
        required: true
      },
      user: {
        type: "string",
        required: true
      },
      title: {
        type: "string"
      },
      description: {
        type: "string"
      },
      status: {
        // use an array to type an enum
        type: ["open", "in-progress", "on-hold", "closed"] as const,
        default: "open"
      },
      points: {
        type: "number",
        required: true
      },
      tags: {
        type: "set",
        items: "string"
      },
      comments: {
        type: "list",
        items: {
          type: "map",
          properties: {
            user: {
              type: "string"
            },
            body: {
              type: "string"
            },
            createdAt: {
              type: "number",
              default: () => Date.now()
            }
          }
        }
      },
      createdAt: {
        type: "number",
        default: () => Date.now(),
        // cannot be modified after created
        readOnly: true
      },
      updatedAt: {
        type: "number",
        // watch for changes to any attribute
        watch: "*",
        // set value by default
        set: () => Date.now(),
        readOnly: true
      }
    },
    indexes: {
      projects: {
        pk: {
          field: "pk",
          composite: ["organization"]
        },
        sk: {
          field: "sk",
          // create composite keys for partial sort key queries
          composite: ["project", "task"]
        }
      },
      assigned: {
        // collections allow for queries across multiple entities
        collection: "assignments",
        index: "gsi1pk-gsi1sk-index",
        pk: {
          // map to your GSI Hash/Partition key
          field: "gsi1pk",
          composite: ["organization", "user"]
        },
        sk: {
          // map to your GSI Range/Sort key
          field: "gsi1sk",
          composite: ["status"]
        }
      },
      recent: {
        // map to the GSI name on your DynamoDB table
        index: "gsi2pk-gsi2sk-index",
        pk: {
          field: "gsi2pk",
          composite: ["project"]
        },
        sk: {
          field: "gsi2sk",
          composite: ["updatedAt"],
          // templates allow for greater control of keys
          template: "\${updatedAt}"
        }
      }
    }
  },
  { table }
);

/* Users Entity */
const users = new Entity(
  {
    model: {
      entity: "user",
      service: "taskapp",
      version: "1"
    },
    attributes: {
      organization: {
        type: "string"
      },
      user: {
        type: "string"
      },
      fullName: {
        type: "string"
      },
      profile: {
        type: "map",
        properties: {
          photo: {
            type: "string"
          },
          bio: {
            type: "string"
          },
          location: {
            type: "string"
          }
        }
      },
      pinned: {
        type: "any"
      },
      following: {
        type: "set",
        items: "string"
      },
      followers: {
        type: "set",
        items: "string"
      },
      createdAt: {
        type: "number",
        default: () => Date.now(),
        readOnly: true
      },
      updatedAt: {
        type: "number",
        watch: "*",
        set: () => Date.now(),
        readOnly: true
      }
    },
    indexes: {
      users: {
        collection: "organization",
        pk: {
          composite: ["organization"],
          field: "pk"
        },
        sk: {
          composite: ["user"],
          field: "sk"
        }
      },
      lookup: {
        collection: "assignments",
        index: "gsi1pk-gsi1sk-index",
        pk: {
          composite: ["organization", "user"],
          field: "gsi1pk"
        },
        sk: {
          field: "gsi1sk",
          composite: []
        }
      }
    }
  },
  { table }
);

const app = new Service({ users, tasks });

/* Write queries to generate parameters on the right */

const user = "d.huynh";
const project = "core";
const task = "45-662";
const organization = "nike";

const comment = {
  user: "janet",
  body: "This seems half-baked."
};

tasks
  .patch({ task, project, organization })
  .set({ status: "on-hold" })
  .add({ tags: ["half-baked"]})
  .append({ comments: [comment] })
  .where(({status}, {eq}) => eq(status, "in-progress"))
  .go();

const hour = 1000 * 60 & 60;
const today = Date.now();
const yesterday = today - 24 * hour;

tasks.query
  .recent({project})
  .between(
    { updatedAt: yesterday },
    { updatedAt: today },
  )
  .go()

app.collections
  .assignments({ organization, user })
  .where(({ points }, { notExists, gte }) => \`
    \${notExists(points)} OR \${gte(points, 5)}
  \`)
  .go();
`

        const isOK = main && window.ts && sandboxFactory
        if (isOK) {
          document.getElementById('loader').parentNode.removeChild(document.getElementById('loader'))
        } else {
          console.error('Could not get all the dependencies of sandbox set up!');
          console.error('main', !!main, 'ts', !!window.ts, 'sandbox', !!sandbox);
          return;
        }

        // Create a sandbox and embed it into the the div #editor
        const sandboxConfig = {
          text: initialCode,
          compilerOptions: {},
          domID: 'editor',
          automaticLayout: true,
          monacoSettings: {
            theme: 'electrodb',
            fontSize: 14,
            fontFamily: 'JetBrains Mono',
            // lineNumbers: "off"
          }
        }

        function sendChanges(code) {
          window.top.postMessage(code, '*');
        }
        main.editor.defineTheme("electrodb", {
          base: 'vs-dark',
          // base: "hc-black",
          inherit: true,
          colors: {
            "focusBorder": "#388bfd",
            "foreground": "#c9d1d9",
            "descriptionForeground": "#8b949e",
            "errorForeground": "#f85149",
            "editor.foreground": "#c9d1d9",
            "editor.background": "#0d1117",
            // "editor.background": "#1a212a",
            // "scrollbar.shadow": "#0008",
            "scrollbar.shadow": "#0d1117",
            "scrollbarSlider.background": "#484F5833",
            "scrollbarSlider.hoverBackground": "#484F5844",
            "scrollbarSlider.activeBackground": "#484F5888",
            "editorOverviewRuler.border": "#010409",
          },
          rules: [
            {
              "token": "type",
              // "foreground": "3DC9B0"
              "foreground": "#4781b7",
              "fontStyle": "bold"
            },
            { token: 'number', foreground: "#ffc107" },
            { token: 'regexp', foreground: "#ffc107" },
            { token: 'boolean', foreground: "#ffc107" },
            {
              "foreground": "#8b949e",
              "token": "comment"
            },
            {
              "foreground": "#8b949e",
              "token": "punctuation.definition.comment"
            },
            {
              "foreground": "#8b949e",
              "token": "string.comment"
            },
            {
              "foreground": "#79c0ff",
              "token": "constant"
            },
            {
              "foreground": "#79c0ff",
              "token": "entity.name.constant"
            },
            {
              "foreground": "#79c0ff",
              "token": "variable.other.constant"
            },
            {
              "foreground": "#79c0ff",
              "token": "variable.language"
            },
            {
              "foreground": "#79c0ff",
              "token": "entity"
            },
            {
              "foreground": "#ffa657",
              "token": "entity.name"
            },
            {
              "foreground": "#ffa657",
              "token": "meta.export.default"
            },
            {
              "foreground": "#ffa657",
              "token": "meta.definition.variable"
            },
            {
              // "foreground": "#c9d1d9",
              "foreground": "#ffc107",
              "token": "variable.parameter.function"
            },
            { "token": "variable.parameter", "foreground": "#f08d39" },
            { "token": "parameter.variable", "foreground": "#f08d39" },
            { "token": "meta.function.parameter variable", "foreground": "#f08d39" },
            {
              "foreground": "#c9d1d9",
              "token": "meta.jsx.children"
            },
            {
              "foreground": "#c9d1d9",
              "token": "meta.block"
            },
            {
              "foreground": "#c9d1d9",
              "token": "meta.tag.attributes"
            },
            {
              "foreground": "#c9d1d9",
              "token": "entity.name.constant"
            },
            {
              "foreground": "#c9d1d9",
              "token": "meta.object.member"
            },
            {
              "foreground": "#c9d1d9",
              "token": "meta.embedded.expression"
            },
            {
              "foreground": "#d2a8ff",
              "token": "entity.name.function"
            },
            {
              "foreground": "#7ee787",
              "token": "entity.name.tag"
            },
            {
              "foreground": "#7ee787",
              "token": "support.class.component"
            },
            {
              // "foreground": "#ff7b72",
              // "foreground": "#4781b7",
              "foreground": "#ffc107",
              "token": "keyword"
            },
            {
              // "foreground": "#ff7b72",
              "foreground": "#4781b7",
              "token": "storage"
            },
            {
              // "foreground": "#ff7b72",
              "foreground": "#4781b7",
              "token": "storage.type"
            },
            {
              "foreground": "#c9d1d9",
              "token": "storage.modifier.package"
            },
            {
              "foreground": "#c9d1d9",
              "token": "storage.modifier.import"
            },
            {
              "foreground": "#c9d1d9",
              "token": "storage.type.java"
            },
            {
              "foreground": "#79c0ff",
              "token": "string"
            },
            {
              "foreground": "#79c0ff",
              "token": "punctuation.definition.string"
            },
            {
              "foreground": "#79c0ff",
              "token": "string punctuation.section.embedded source"
            },
            {
              "foreground": "#79c0ff",
              "token": "support"
            },
            {
              "foreground": "#79c0ff",
              "token": "meta.property-name"
            },
            {
              "foreground": "#ffa657",
              "token": "variable"
            },
            {
              "foreground": "#c9d1d9",
              "token": "variable.other"
            },
            {
              "fontStyle": "italic",
              "foreground": "#ffa198",
              "token": "invalid.broken"
            },
            {
              "fontStyle": "italic",
              "foreground": "#ffa198",
              "token": "invalid.deprecated"
            },
            {
              "fontStyle": "italic",
              "foreground": "#ffa198",
              "token": "invalid.illegal"
            },
            {
              "fontStyle": "italic",
              "foreground": "#ffa198",
              "token": "invalid.unimplemented"
            },
            {
              "fontStyle": "italic underline",
              "background": "#ff7b72",
              // "background": "#ffc107",
              "foreground": "#0d1117",
              "content": "^M",
              "token": "carriage-return"
            },
            {
              "foreground": "#ffa198",
              "token": "message.error"
            },
            {
              "foreground": "#c9d1d9",
              "token": "string source"
            },
            {
              "foreground": "#79c0ff",
              "token": "string variable"
            },
            {
              "foreground": "#79c0ff",
              "token": "source.regexp"
            },
            {
              "foreground": "#79c0ff",
              "token": "string.regexp"
            },
            {
              "foreground": "#79c0ff",
              "token": "string.regexp.character-class"
            },
            {
              "foreground": "#79c0ff",
              "token": "string.regexp constant.character.escape"
            },
            {
              "foreground": "#79c0ff",
              "token": "string.regexp source.ruby.embedded"
            },
            {
              "foreground": "#79c0ff",
              "token": "string.regexp string.regexp.arbitrary-repitition"
            },
            {
              "fontStyle": "bold",
              "foreground": "#7ee787",
              "token": "string.regexp constant.character.escape"
            },
            {
              "foreground": "#79c0ff",
              "token": "support.constant"
            },
            {
              "foreground": "#79c0ff",
              "token": "support.variable"
            },
            {
              "foreground": "#79c0ff",
              "token": "meta.module-reference"
            },
            {
              "foreground": "#ffa657",
              "token": "punctuation.definition.list.begin.markdown"
            },
            {
              "fontStyle": "bold",
              "foreground": "#79c0ff",
              "token": "markup.heading"
            },
            {
              "fontStyle": "bold",
              "foreground": "#79c0ff",
              "token": "markup.heading entity.name"
            },
            {
              "foreground": "#7ee787",
              "token": "markup.quote"
            },
            {
              "fontStyle": "italic",
              "foreground": "#c9d1d9",
              "token": "markup.italic"
            },
            {
              "fontStyle": "bold",
              "foreground": "#c9d1d9",
              "token": "markup.bold"
            },
            {
              "foreground": "#79c0ff",
              "token": "markup.raw"
            },
            {
              "background": "#490202",
              "foreground": "#ffa198",
              "token": "markup.deleted"
            },
            {
              "background": "#490202",
              "foreground": "#ffa198",
              "token": "meta.diff.header.from-file"
            },
            {
              "background": "#490202",
              "foreground": "#ffa198",
              "token": "punctuation.definition.deleted"
            },
            {
              "background": "#04260f",
              "foreground": "#7ee787",
              "token": "markup.inserted"
            },
            {
              "background": "#04260f",
              "foreground": "#7ee787",
              "token": "meta.diff.header.to-file"
            },
            {
              "background": "#04260f",
              "foreground": "#7ee787",
              "token": "punctuation.definition.inserted"
            },
            {
              "background": "#5a1e02",
              "foreground": "#ffa657",
              "token": "markup.changed"
            },
            {
              "background": "#5a1e02",
              "foreground": "#ffa657",
              "token": "punctuation.definition.changed"
            },
            {
              "foreground": "#161b22",
              "background": "#79c0ff",
              "token": "markup.ignored"
            },
            {
              "foreground": "#161b22",
              "background": "#79c0ff",
              "token": "markup.untracked"
            },
            {
              "foreground": "#d2a8ff",
              "fontStyle": "bold",
              "token": "meta.diff.range"
            },
            {
              "foreground": "#79c0ff",
              "token": "meta.diff.header"
            },
            {
              "fontStyle": "bold",
              "foreground": "#79c0ff",
              "token": "meta.separator"
            },
            {
              "foreground": "#79c0ff",
              "token": "meta.output"
            },
            {
              "foreground": "#8b949e",
              "token": "brackethighlighter.tag"
            },
            {
              "foreground": "#8b949e",
              "token": "brackethighlighter.curly"
            },
            {
              "foreground": "#8b949e",
              "token": "brackethighlighter.round"
            },
            {
              "foreground": "#8b949e",
              "token": "brackethighlighter.square"
            },
            {
              "foreground": "#8b949e",
              "token": "brackethighlighter.angle"
            },
            {
              "foreground": "#8b949e",
              "token": "brackethighlighter.quote"
            },
            {
              "foreground": "#ffa198",
              "token": "brackethighlighter.unmatched"
            },
            {
              "foreground": "#79c0ff",
              "fontStyle": "underline",
              "token": "constant.other.reference.link"
            },
            {
              "foreground": "#79c0ff",
              "fontStyle": "underline",
              "token": "string.other.link"
            }
          ]
        })
        const sandbox = sandboxFactory.createTypeScriptSandbox(sandboxConfig, main, window.ts);
        sandbox.languageServiceDefaults.addExtraLib('./electrodb.d.ts');
        sandbox.editor.onDidType(() => {
          sandbox.getRunnableJS().then(sendChanges);
        });
        sandbox.editor.focus();

      });
    }

    document.body.appendChild(getLoaderScript);
    window.onmessage = function(e) {
        // if (e.data == 'hello') {
            // console.log('It works inside editor!' + e.data);
        // }
    };
  </script>
</html>
